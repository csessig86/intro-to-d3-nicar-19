<html>
    <head>
        <title>Iowa's energy mix (2001-2017)</title>
        <script type="text/javascript" src="d3v5.js"></script>
        <style type="text/css">
        </style>
    </head>
    <body>
        <script type="text/javascript">

            function transformData(data) {
                return data.map(
                    function (row) {
                        return {
                            year: row.year.substring(0,4),
                            source: row.source,
                            megawatts: +row.net_generation,
                        }
                    }
                )
            }

            function makeChart(rawData) {
                var chartMargin = {top: 10, right: 10, bottom: 10, left: 10};
                var chartWidth = 500;
                var chartHeight = 300;

                var container = d3.select('body')
                    .append('svg')
                        .attr('id', 'container')
                        .attr('width', chartWidth + chartMargin.left + chartMargin.right)
                        .attr('height', chartHeight + chartMargin.top + chartMargin.bottom);

                var canvas = container.append('g')
                        .attr('id', 'canvas')
                        .attr('transform', 'translate(' + chartMargin.left + ',' + chartMargin.top + ')');

                var data = transformData(rawData);

                var dataByYear = d3.nest()
                    .key(function(d) { return d.year })
                    .entries(data);

                var maxByYear = d3.nest()
                    .key(function(d) { return d.year })
                    .rollup(function(group) { return d3.max(group, function(d) { return d.megawatts }) })
                    .entries(data);

                var yearScale = d3.scaleBand()
                    .domain(maxByYear.map(function(d) { return d.key }))
                    .range([chartMargin.left, chartWidth - chartMargin.right])
                    .padding(0.1);

                var sourceScale = d3.scaleBand()
                    .domain(['Nuclear Energy','Fossil Fuels', 'Renewables'])
                    .rangeRound([0, yearScale.bandwidth()])
                    .padding(0.05);

                var colorScale = d3.scaleOrdinal()
                    .domain(['Nuclear Energy','Fossil Fuels', 'Renewables'])
                    .range(['rgb(66, 136, 181)','#fec44f', 'teal'])

                var megawattScale = d3.scaleLinear()
                    .domain([0, d3.max(maxByYear, function(d) { return d.value })]).nice()
                    .range([chartHeight - chartMargin.bottom, chartMargin.top]);

                canvas.append("g")
                    .selectAll("g")
                    .data(dataByYear)
                    .enter().append('g')
                        .attr("transform", function(d) { return "translate(" + yearScale(d.key) + ",0)"; })
                        .attr("data-year", function(d) { return d.key })
                        .selectAll("rect")
                            .data(function(d) { return d.values })
                            .enter().append("rect")
                                .attr('data-source', function(d) { return d.source })
                                .attr("x", function(d) { return sourceScale(d.source); })
                                .attr("y", function(d) { return megawattScale(d.megawatts); })
                                .attr("width", sourceScale.bandwidth())
                                .attr("height", function(d) { return chartHeight - megawattScale(d.megawatts); })
                                .attr("fill", function(d) { return colorScale(d.source); });
            }

            d3.csv('../iowa-electricity.csv').then(makeChart);

        </script>
    </body>
</html>